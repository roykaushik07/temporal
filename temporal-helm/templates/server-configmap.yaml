apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "temporal.fullname" . }}-config
  labels:
    {{- include "temporal.labels" . | nindent 4 }}
data:
  config_template.yaml: |
    log:
      stdout: true
      level: {{ .Values.server.config.log.level }}
      format: {{ .Values.server.config.log.format }}

    persistence:
      defaultStore: default
      visibilityStore: visibility
      numHistoryShards: 512
      datastores:
        default:
          sql:
            pluginName: postgres
            databaseName: {{ .Values.postgresql.auth.database }}
            connectAddr: {{ include "temporal.database.host" . }}:{{ .Values.postgresql.primary.service.ports.postgresql | default 5432 }}
            connectProtocol: tcp
            user: {{ .Values.postgresql.auth.username }}
            password: {{ "{{" }} .Env.POSTGRES_PWD {{ "}}" }}
            maxConns: {{ .Values.server.config.persistence.default.sql.maxConns }}
            maxIdleConns: 10
            maxConnLifetime: {{ .Values.server.config.persistence.default.sql.maxConnLifetime }}
            {{- if .Values.tls.enabled }}
            tls:
              enabled: true
              enableHostVerification: true
              {{- end }}
        visibility:
          sql:
            pluginName: postgres
            databaseName: temporal_visibility
            connectAddr: {{ include "temporal.database.host" . }}:{{ .Values.postgresql.primary.service.ports.postgresql | default 5432 }}
            connectProtocol: tcp
            user: {{ .Values.postgresql.auth.username }}
            password: {{ "{{" }} .Env.POSTGRES_PWD {{ "}}" }}
            maxConns: {{ .Values.server.config.persistence.visibility.sql.maxConns }}
            maxIdleConns: 10
            maxConnLifetime: {{ .Values.server.config.persistence.visibility.sql.maxConnLifetime }}
            {{- if .Values.tls.enabled }}
            tls:
              enabled: true
              enableHostVerification: true
            {{- end }}

    global:
      membership:
        maxJoinDuration: {{ .Values.server.config.global.membership.maxJoinDuration }}
        broadcastAddress: {{ .Values.server.config.global.membership.broadcastAddress }}
      pprof:
        port: {{ .Values.server.config.global.pprof.port }}
      metrics:
        prometheus:
          timerType: {{ .Values.server.config.global.metrics.prometheus.timerType }}
          listenAddress: {{ .Values.server.config.global.metrics.prometheus.listenAddress }}
      {{- if .Values.tls.enabled }}
      tls:
        frontend:
          server:
            certFile: /etc/temporal/config/certs/frontend/tls.crt
            keyFile: /etc/temporal/config/certs/frontend/tls.key
          {{- if .Values.tls.frontend.client.requireClientAuth }}
          client:
            rootCAFiles:
              - /etc/temporal/config/certs/ca/ca.crt
          {{- end }}
        {{- if .Values.tls.internode.enabled }}
        internode:
          server:
            certFile: /etc/temporal/config/certs/internode/tls.crt
            keyFile: /etc/temporal/config/certs/internode/tls.key
            requireClientAuth: {{ .Values.tls.internode.server.requireClientAuth }}
          client:
            rootCAFiles:
              - /etc/temporal/config/certs/ca/ca.crt
            serverName: {{ .Values.tls.internode.client.serverName }}
        {{- end }}
      {{- end }}

    services:
      frontend:
        rpc:
          grpcPort: {{ .Values.server.service.frontend.port }}
          membershipPort: 6933
          bindOnIP: {{ .Values.server.config.services.frontend.rpc.bindOnIP }}
      history:
        rpc:
          grpcPort: {{ .Values.server.service.history.port }}
          membershipPort: 6934
          bindOnIP: {{ .Values.server.config.services.history.rpc.bindOnIP }}
      matching:
        rpc:
          grpcPort: {{ .Values.server.service.matching.port }}
          membershipPort: 6935
          bindOnIP: {{ .Values.server.config.services.matching.rpc.bindOnIP }}
      worker:
        rpc:
          grpcPort: {{ .Values.server.service.worker.port }}
          membershipPort: 6939
          bindOnIP: {{ .Values.server.config.services.worker.rpc.bindOnIP }}

    {{- if .Values.auth.enabled }}
    authorization:
      jwtKeyProvider:
        keySourceURIs:
          - file:///etc/temporal/config/certs/jwt/public-key.pem
      permissionsClaimName: permissions
      authorizer: {{ .Values.auth.authorizer.pluginPath | default "default" }}
      claimMapper: {{ .Values.auth.claimMapper | default "default" }}
    {{- end }}

    clusterMetadata:
      enableGlobalNamespace: false
      failoverVersionIncrement: 10
      masterClusterName: active
      currentClusterName: active
      clusterInformation:
        active:
          enabled: true
          initialFailoverVersion: 1
          rpcName: frontend
          rpcAddress: {{ include "temporal.fullname" . }}-frontend:{{ .Values.server.service.frontend.port }}

    dcRedirectionPolicy:
      policy: noop

    archival:
      history:
        state: {{ if .Values.archival.enabled }}enabled{{ else }}disabled{{ end }}
        enableRead: {{ .Values.archival.enabled }}
        {{- if .Values.archival.enabled }}
        provider:
          {{- toYaml .Values.archival.history | nindent 10 }}
        {{- end }}

    namespaceDefaults:
      archival:
        history:
          state: {{ if .Values.archival.enabled }}enabled{{ else }}disabled{{ end }}
          URI: {{ .Values.archival.history.s3.bucket | default "" }}

    dynamicConfigClient:
      filepath: {{ .Values.server.config.dynamicConfigClient.filepath }}
      pollInterval: {{ .Values.server.config.dynamicConfigClient.pollInterval }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "temporal.fullname" . }}-dynamic-config
  labels:
    {{- include "temporal.labels" . | nindent 4 }}
data:
  dynamic_config.yaml: |
    {{- range $key, $value := .Values.dynamicConfig }}
    {{ $key }}:
    {{- range $value }}
      - value: {{ .value }}
        {{- if .constraints }}
        constraints:
          {{- toYaml .constraints | nindent 10 }}
        {{- end }}
    {{- end }}
    {{- end }}
